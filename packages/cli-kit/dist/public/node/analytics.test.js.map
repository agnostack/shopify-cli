{"version":3,"file":"analytics.test.js","sourceRoot":"","sources":["../../../src/public/node/analytics.test.ts"],"names":[],"mappings":"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","sourcesContent":["import {reportAnalyticsEvent} from './analytics.js'\nimport * as ruby from './ruby.js'\nimport * as os from './os.js'\nimport {\n  analyticsDisabled,\n  ciPlatform,\n  cloudEnvironment,\n  isDevelopment,\n  isShopify,\n  isUnitTest,\n  macAddress,\n} from './context/local.js'\nimport {inTemporaryDirectory, touchFile, mkdir} from './fs.js'\nimport {joinPath, dirname} from './path.js'\nimport {publishMonorailEvent} from './monorail.js'\nimport {mockAndCaptureOutput} from './testing/output.js'\nimport {startAnalytics} from '../../private/node/analytics.js'\nimport {hashString} from '../../public/node/crypto.js'\nimport {CLI_KIT_VERSION} from '../common/version.js'\nimport {test, expect, describe, vi, beforeEach, afterEach, MockedFunction} from 'vitest'\n\nvi.mock('./context/local.js')\nvi.mock('./ruby.js')\nvi.mock('./os.js')\nvi.mock('../../store.js')\nvi.mock('../../public/node/crypto.js')\nvi.mock('../../version.js')\nvi.mock('./monorail.js')\nvi.mock('./cli.js')\n\ndescribe('event tracking', () => {\n  const currentDate = new Date(Date.UTC(2022, 1, 1, 10, 0, 0))\n  let publishEventMock: MockedFunction<typeof publishMonorailEvent>\n\n  beforeEach(() => {\n    vi.setSystemTime(currentDate)\n    vi.mocked(isShopify).mockResolvedValue(false)\n    vi.mocked(isDevelopment).mockReturnValue(false)\n    vi.mocked(analyticsDisabled).mockReturnValue(false)\n    vi.mocked(ciPlatform).mockReturnValue({isCI: true, name: 'vitest', metadata: {}})\n    vi.mocked(macAddress).mockResolvedValue('macAddress')\n    vi.mocked(hashString).mockReturnValue('hashed-macaddress')\n    vi.mocked(isUnitTest).mockReturnValue(true)\n    vi.mocked(cloudEnvironment).mockReturnValue({platform: 'spin', editor: false})\n    vi.mocked(ruby.version).mockResolvedValue('3.1.1')\n    vi.mocked(os.platformAndArch).mockReturnValue({platform: 'darwin', arch: 'arm64'})\n    publishEventMock = vi.mocked(publishMonorailEvent).mockReturnValue(Promise.resolve({type: 'ok'}))\n  })\n\n  afterEach(() => {\n    vi.useRealTimers()\n  })\n\n  async function inProjectWithFile(file: string, execute: (args: string[]) => Promise<void>): Promise<void> {\n    await inTemporaryDirectory(async (tmpDir) => {\n      const packageJsonPath = joinPath(tmpDir, `web/${file}`)\n      await mkdir(dirname(packageJsonPath))\n      await touchFile(packageJsonPath)\n      await execute(['--path', tmpDir])\n    })\n  }\n\n  test('sends the expected data to Monorail with cached app info', async () => {\n    await inProjectWithFile('package.json', async (args) => {\n      // Given\n      const commandContent = {command: 'dev', topic: 'app', alias: 'alias'}\n      await startAnalytics({commandContent, args, currentTime: currentDate.getTime() - 100})\n\n      // When\n      const config = {\n        runHook: vi.fn().mockResolvedValue({successes: [], failures: []}),\n        plugins: [\n          {\n            name: '@shopify/built-in',\n          },\n          {\n            name: 'a-custom-plugin',\n          },\n        ],\n      } as any\n      await reportAnalyticsEvent({config})\n      // Then\n      const version = CLI_KIT_VERSION\n      const expectedPayloadPublic = {\n        command: commandContent.command,\n        cmd_all_alias_used: commandContent.alias,\n        cmd_all_topic: commandContent.topic,\n        time_start: 1643709599900,\n        time_end: 1643709600000,\n        total_time: 100,\n        success: true,\n        uname: 'darwin arm64',\n        cli_version: version,\n        ruby_version: '3.1.1',\n        node_version: process.version.replace('v', ''),\n        is_employee: false,\n        env_plugin_installed_any_custom: true,\n        env_plugin_installed_shopify: JSON.stringify(['@shopify/built-in']),\n        env_device_id: 'hashed-macaddress',\n        env_cloud: 'spin',\n      }\n      const expectedPayloadSensitive = {\n        args: args.join(' '),\n        metadata: expect.anything(),\n        env_plugin_installed_all: JSON.stringify(['@shopify/built-in', 'a-custom-plugin']),\n      }\n      expect(publishEventMock).toHaveBeenCalledOnce()\n      expect(publishEventMock.mock.calls[0]![1]).toMatchObject(expectedPayloadPublic)\n      expect(publishEventMock.mock.calls[0]![2]).toMatchObject(expectedPayloadSensitive)\n    })\n  })\n\n  test('sends the expected data to Monorail when there is an error message', async () => {\n    await inProjectWithFile('package.json', async (args) => {\n      // Given\n      const commandContent = {command: 'dev', topic: 'app'}\n      await startAnalytics({commandContent, args, currentTime: currentDate.getTime() - 100})\n\n      // When\n      const config = {\n        runHook: vi.fn().mockResolvedValue({successes: [], failures: []}),\n        plugins: [],\n      } as any\n      await reportAnalyticsEvent({config, errorMessage: 'Permission denied'})\n\n      // Then\n      const version = CLI_KIT_VERSION\n      const expectedPayloadPublic = {\n        command: commandContent.command,\n        time_start: 1643709599900,\n        time_end: 1643709600000,\n        total_time: 100,\n        success: false,\n        uname: 'darwin arm64',\n        cli_version: version,\n        ruby_version: '3.1.1',\n        node_version: process.version.replace('v', ''),\n        is_employee: false,\n      }\n      const expectedPayloadSensitive = {\n        args: args.join(' '),\n        error_message: 'Permission denied',\n        metadata: expect.anything(),\n      }\n      expect(publishEventMock).toHaveBeenCalledOnce()\n      expect(publishEventMock.mock.calls[0]![1]).toMatchObject(expectedPayloadPublic)\n      expect(publishEventMock.mock.calls[0]![2]).toMatchObject(expectedPayloadSensitive)\n    })\n  })\n\n  test('does not send passwords to Monorail', async () => {\n    await inProjectWithFile('package.json', async (args) => {\n      // Given\n      const commandContent = {command: 'dev', topic: 'app'}\n      const argsWithPassword = args.concat(['--password', 'shptka_abc123'])\n      await startAnalytics({commandContent, args: argsWithPassword, currentTime: currentDate.getTime() - 100})\n\n      // When\n      const config = {\n        runHook: vi.fn().mockResolvedValue({successes: [], failures: []}),\n        plugins: [],\n      } as any\n      await reportAnalyticsEvent({config})\n\n      // Then\n      const expectedPayloadSensitive = {\n        args: expect.stringMatching(/.*password \\*\\*\\*\\*\\*/),\n        metadata: expect.anything(),\n      }\n      expect(publishEventMock).toHaveBeenCalledOnce()\n      expect(publishEventMock.mock.calls[0]![2]).toMatchObject(expectedPayloadSensitive)\n    })\n  })\n\n  test('does nothing when analytics are disabled', async () => {\n    await inProjectWithFile('package.json', async (args) => {\n      // Given\n      vi.mocked(analyticsDisabled).mockReturnValueOnce(true)\n      const commandContent = {command: 'dev', topic: 'app'}\n      await startAnalytics({commandContent, args, currentTime: currentDate.getTime() - 100})\n\n      // When\n      const config = {\n        runHook: vi.fn().mockResolvedValue({successes: [], failures: []}),\n        plugins: [],\n      } as any\n      await reportAnalyticsEvent({config})\n\n      // Then\n      expect(publishMonorailEvent).not.toHaveBeenCalled()\n    })\n  })\n\n  test('shows an error if something else fails', async () => {\n    await inProjectWithFile('package.json', async (args) => {\n      // Given\n      const commandContent = {command: 'dev', topic: 'app'}\n      vi.mocked(os.platformAndArch).mockImplementationOnce(() => {\n        throw new Error('Boom!')\n      })\n      const outputMock = mockAndCaptureOutput()\n      await startAnalytics({commandContent, args})\n\n      // When\n      const config = {\n        runHook: vi.fn().mockResolvedValue({successes: [], failures: []}),\n        plugins: [],\n      } as any\n      await reportAnalyticsEvent({config})\n\n      // Then\n      expect(outputMock.debug()).toMatch('Failed to report usage analytics: Boom!')\n    })\n  })\n})\n"]}